#!/bin/bash
set -e

echo "๐ ุจุฏุก ุชุฌููุฒ ุงููุดุฑูุน ุงููุงูู (Fabric + Caliper)..."
echo "=================================================="

# ============================================================
# ุงููุฑุญูุฉ 1: ุชุญููู ุฃุฏูุงุช Hyperledger Fabric
# ============================================================
echo ""
echo "๐ฆ ุงููุฑุญูุฉ 1: ุงูุชุญูู ูู ุฃุฏูุงุช Fabric..."

if [ ! -d "bin" ]; then
    echo "โฌ๏ธ  ุฌุงุฑู ุชุญููู ุฃุฏูุงุช Fabric (Binaries) - ูุฏ ูุณุชุบุฑู ุจุถุน ุฏูุงุฆู..."
    curl -sSL https://bit.ly/2ysbOFE | bash -s -- 2.5.9 1.5.7
    echo "โ ุชู ุชุญููู ุงูุฃุฏูุงุช ุจูุฌุงุญ"
else
    echo "โ ุงูุฃุฏูุงุช ููุฌูุฏุฉ ูุณุจูุงู"
fi

# ============================================================
# ุงููุฑุญูุฉ 2: ุชุดุบูู ุดุจูุฉ Fabric
# ============================================================
echo ""
echo "๐ ุงููุฑุญูุฉ 2: ุชุดุบูู ุดุจูุฉ Fabric..."

cd test-network || { echo "โ ูุฌูุฏ test-network ุบูุฑ ููุฌูุฏ!"; exit 1; }

# ููุญ ุตูุงุญูุงุช ุงูุชูููุฐ
echo "๐ ููุญ ุตูุงุญูุงุช ุงูุชูููุฐ..."
chmod -R +x .

# ุชูุธูู ุงูุดุจูุฉ ุงููุฏููุฉ
echo "๐งน ุชูุธูู ุฃู ุดุจูุฉ ุณุงุจูุฉ..."
./network.sh down

# ุชุดุบูู ุงูุดุจูุฉ ูุน CA
echo "๐ ุชุดุบูู ุงูุดุจูุฉ ูุฅูุดุงุก ุงูููุงุฉ (mychannel)..."
./network.sh up createChannel -ca

if [ $? -ne 0 ]; then
    echo "โ ูุดู ุชุดุบูู ุงูุดุจูุฉ!"
    exit 1
fi

echo "โ ุงูุดุจูุฉ ุชุนูู ุจูุฌุงุญ"

# ============================================================
# ุงููุฑุญูุฉ 3: ูุดุฑ ุงูุนูุฏ ุงูุฐูู (Go)
# ============================================================
echo ""
echo "๐ ุงููุฑุญูุฉ 3: ูุดุฑ ุงูุนูุฏ ุงูุฐูู (chaincode-go)..."

./network.sh deployCC \
  -ccn basic \
  -ccp ../asset-transfer-basic/chaincode-go \
  -ccl go

if [ $? -ne 0 ]; then
    echo "โ ูุดู ูุดุฑ ุงูุนูุฏ ุงูุฐูู!"
    exit 1
fi

echo "โ ุชู ูุดุฑ ุงูุนูุฏ ุงูุฐูู ุจูุฌุงุญ"

# ============================================================
# ุงููุฑุญูุฉ 4: ุฅุนุฏุงุฏ ูุชุดุบูู Caliper
# ============================================================
echo ""
echo "โก ุงููุฑุญูุฉ 4: ุฅุนุฏุงุฏ ูุชุดุบูู Caliper..."

cd ../caliper-workspace || { echo "โ ูุฌูุฏ caliper-workspace ุบูุฑ ููุฌูุฏ!"; exit 1; }

# ุงูุชุญูู ูู ูุฌูุฏ ุงูุณูุฑุจุช
if [ ! -f "fix_and_run_caliper.sh" ]; then
    echo "โ ููู fix_and_run_caliper.sh ุบูุฑ ููุฌูุฏ!"
    exit 1
fi

# ููุญ ุตูุงุญูุงุช ุงูุชูููุฐ
chmod +x fix_and_run_caliper.sh

# ุชุดุบูู Caliper
echo "๐ฅ ุชุดุบูู ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก..."
./fix_and_run_caliper.sh

# ============================================================
# ุงูููุงูุฉ
# ============================================================
echo ""
echo "=================================================="
echo "๐ ุชู ุงูุงูุชูุงุก ูู ุฌููุน ุงููุฑุงุญู ุจูุฌุงุญ!"
echo "=================================================="
echo ""
echo "๐ ุงููุชุงุฆุฌ:"
echo "  - ุงูุดุจูุฉ: ุชุนูู โ"
echo "  - ุงูุนูุฏ ุงูุฐูู (Go): ููุดูุฑ โ"
echo "  - ุงุฎุชุจุงุฑ Caliper: ููุชูู โ"
echo ""
echo "๐ ูุนุฑุถ ุงูุชูุฑูุฑ:"
echo "  ุงูุชุญ ููู: caliper-workspace/report.html"
echo ""
